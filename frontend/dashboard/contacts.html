<!DOCTYPE html>

<html lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Wamator | All Contacts Management</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script src="/assets/css/tailwind-config.js"></script>
<link href="/assets/css/app.css" rel="stylesheet"/>
<script src="/assets/js/api.js"></script>
<script src="/assets/js/auth.js"></script>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 min-h-screen flex">
<!-- Sidebar Navigation -->
<aside class="w-64 border-r border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 flex flex-col hidden lg:flex">
<div class="p-6">
<div class="flex items-center gap-2 mb-8">
<div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center">
<span class="material-icons text-white text-xl">bolt</span>
</div>
<span class="text-xl font-bold tracking-tight">Wamator</span>
</div>
<nav class="space-y-1">
<a class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg font-medium transition-colors" href="/dashboard/">
<span class="material-icons text-sm">dashboard</span>
                    Dashboard
                </a>
<a class="flex items-center gap-3 px-3 py-2 text-primary bg-primary/10 rounded-lg font-medium" href="/dashboard/contacts.html">
<span class="material-icons text-sm">people</span>
                    All Contacts
                </a>
<a class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg font-medium transition-colors" href="/dashboard/automation.html">
<span class="material-icons text-sm">smart_toy</span>
                    Automations
                </a>
<a class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg font-medium transition-colors" href="#">
<span class="material-icons text-sm">campaign</span>
                    Campaigns
                </a>
<a class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg font-medium transition-colors" href="#">
<span class="material-icons text-sm">settings</span>
                    Settings
                </a>
</nav>
</div>
<div class="mt-auto p-6 border-t border-slate-200 dark:border-slate-800">
<div class="flex items-center gap-3">
<div class="w-10 h-10 rounded-full bg-primary/10 text-primary flex items-center justify-center font-bold text-xs" id="sidebar-avatar">--</div>
<div>
<p class="text-sm font-semibold" id="sidebar-name">Loading...</p>
<p class="text-xs text-slate-400" id="sidebar-plan">—</p>
</div>
<button onclick="WamatorAuth.logout()" class="ml-auto text-slate-400 hover:text-red-500" title="Log out">
<span class="material-icons text-sm">logout</span>
</button>
</div>
</div>
</aside>
<!-- Main Content Area -->
<main class="flex-1 flex flex-col h-screen overflow-hidden">
<!-- Header -->
<header class="h-16 border-b border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 px-8 flex items-center justify-between z-10">
<div class="flex items-center gap-4">
<h1 class="text-lg font-semibold">All Contacts</h1>
<span id="total-badge" class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 px-2 py-0.5 rounded-full text-xs font-medium">—</span>
</div>
<div class="flex items-center gap-4">
<div class="relative w-64">
<span class="material-icons absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-lg leading-none">search</span>
<input id="search-input" class="w-full pl-10 pr-4 py-2 bg-slate-50 dark:bg-slate-800 border-none rounded-lg text-sm focus:ring-2 focus:ring-primary/20 transition-all" placeholder="Search contacts..." type="text"/>
</div>
<button class="flex items-center gap-2 px-4 py-2 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-medium hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
<span class="material-icons text-sm">tune</span>
                    Filter
                </button>
<button id="import-btn" class="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium hover:bg-primary/90 transition-all shadow-sm">
<span class="material-icons text-sm">upload</span>
                    Import Contacts
                </button>
</div>
</header>
<!-- Bulk Action Bar (Visible when selected) -->
<div id="bulk-bar" class="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 px-8 py-3 flex items-center justify-between hidden">
<div class="flex items-center gap-6">
<label class="flex items-center gap-3">
<input id="bulk-select-all" class="rounded border-slate-300 dark:border-slate-700 text-primary focus:ring-primary" type="checkbox"/>
<span id="bulk-count" class="text-sm font-medium">0 Selected</span>
</label>
<div class="h-4 w-[1px] bg-slate-200 dark:bg-slate-700"></div>
<div class="flex items-center gap-2">
<button class="p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors" title="Add Tag">
<span class="material-icons text-lg leading-none">label_add</span>
</button>
<button class="p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors" title="Add to List">
<span class="material-icons text-lg leading-none">playlist_add</span>
</button>
<button class="p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors" title="Export Selected">
<span class="material-icons text-lg leading-none">download</span>
</button>
<button id="bulk-delete-btn" class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors" title="Delete Selected">
<span class="material-icons text-lg leading-none">delete</span>
</button>
</div>
</div>
<div class="flex items-center gap-2">
<span class="text-xs text-slate-400">Quick actions for selected contacts</span>
</div>
</div>
<!-- Table Content -->
<div class="flex-1 overflow-auto bg-white dark:bg-slate-900">
<table class="w-full text-left border-collapse">
<thead class="sticky top-0 bg-slate-50 dark:bg-slate-800/50 border-b border-slate-200 dark:border-slate-800 z-10">
<tr>
<th class="pl-8 pr-4 py-4 w-12">
<input id="select-all" class="rounded border-slate-300 dark:border-slate-700 text-primary focus:ring-primary" type="checkbox"/>
</th>
<th class="px-4 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">Name</th>
<th class="px-4 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">Phone Number</th>
<th class="px-4 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">Tags</th>
<th class="px-4 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">Lists</th>
<th class="px-4 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">Last Activity</th>
<th class="px-8 py-4 text-right"></th>
</tr>
</thead>
<tbody id="contacts-tbody" class="divide-y divide-slate-100 dark:divide-slate-800">
<!-- Contacts loaded dynamically -->
<tr><td colspan="7" class="text-center py-12 text-slate-400">Loading contacts...</td></tr>
</tbody>
</table>
</div>
<!-- Pagination -->
<footer class="h-14 border-t border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 px-8 flex items-center justify-between text-sm">
<div class="text-slate-500">
                Showing <span id="page-range" class="font-medium text-slate-900 dark:text-white">—</span> of <span id="page-total" class="font-medium text-slate-900 dark:text-white">—</span>
</div>
<div class="flex items-center gap-2">
<button id="prev-page" class="p-1 hover:bg-slate-100 dark:hover:bg-slate-800 rounded transition-colors text-slate-400" disabled>
<span class="material-icons">chevron_left</span>
</button>
<div id="page-info" class="flex items-center px-2 font-medium">
                    — / —
                </div>
<button id="next-page" class="p-1 hover:bg-slate-100 dark:hover:bg-slate-800 rounded transition-colors text-slate-900 dark:text-white">
<span class="material-icons">chevron_right</span>
</button>
</div>
</footer>
</main>
<!-- Global Floating Action Button for Mobile / Quick Chat -->
<button class="fixed bottom-8 right-8 w-14 h-14 bg-green-500 text-white rounded-full shadow-lg flex items-center justify-center hover:scale-105 transition-transform z-50">
<span class="material-icons text-2xl">chat</span>
</button>

<script>
(async function () {
  const auth = await WamatorAuth.requireAuth();
  if (!auth) return;
  const { vendor, appUser } = auth;

  // Populate sidebar profile
  const avatar = document.getElementById('sidebar-avatar');
  const nameEl = document.getElementById('sidebar-name');
  const planEl = document.getElementById('sidebar-plan');
  if (avatar) avatar.textContent = (vendor.name || 'U')[0].toUpperCase();
  if (nameEl) nameEl.textContent = vendor.name || 'User';
  if (planEl) planEl.textContent = vendor.company_name || 'Free Plan';

  // State
  const LIMIT = 25;
  let currentPage = 1;
  let totalContacts = 0;
  let contacts = [];
  let selectedIds = new Set();
  let searchTerm = '';
  let searchTimer = null;

  // DOM refs
  const tbody = document.getElementById('contacts-tbody');
  const totalBadge = document.getElementById('total-badge');
  const searchInput = document.getElementById('search-input');
  const prevBtn = document.getElementById('prev-page');
  const nextBtn = document.getElementById('next-page');
  const pageRange = document.getElementById('page-range');
  const pageTotal = document.getElementById('page-total');
  const pageInfo = document.getElementById('page-info');
  const selectAll = document.getElementById('select-all');
  const bulkBar = document.getElementById('bulk-bar');
  const bulkCount = document.getElementById('bulk-count');
  const bulkSelectAll = document.getElementById('bulk-select-all');
  const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
  const importBtn = document.getElementById('import-btn');

  // Load contacts
  async function loadContacts() {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-12 text-slate-400">Loading contacts...</td></tr>';
    try {
      const res = await WamatorAPI.get('/contacts/' + appUser.id + '/list?page=' + currentPage + '&limit=' + LIMIT + (searchTerm ? '&search=' + encodeURIComponent(searchTerm) : ''));
      contacts = res.data || [];
      totalContacts = res.pagination ? res.pagination.total : contacts.length;
      renderContacts();
      renderPagination();
      if (totalBadge) totalBadge.textContent = totalContacts.toLocaleString() + ' Total';
    } catch (err) {
      tbody.innerHTML = '<tr><td colspan="7" class="text-center py-12 text-red-400">Failed to load contacts</td></tr>';
    }
  }

  // Render table rows
  function renderContacts() {
    if (!contacts.length) {
      tbody.innerHTML = '<tr><td colspan="7" class="text-center py-12 text-slate-400">No contacts found</td></tr>';
      return;
    }
    tbody.innerHTML = contacts.map(function (c) {
      var initials = ((c.name || c.phone_number || '?').substring(0, 2)).toUpperCase();
      var colors = ['bg-primary/10 text-primary', 'bg-purple-100 text-purple-600', 'bg-pink-100 text-pink-600', 'bg-amber-100 text-amber-600', 'bg-green-100 text-green-600'];
      var color = colors[Math.abs((c.id || 0)) % colors.length];
      var checked = selectedIds.has(c.id) ? 'checked' : '';
      return '<tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">' +
        '<td class="pl-8 pr-4 py-4"><input type="checkbox" class="row-check rounded border-slate-300 dark:border-slate-700 text-primary focus:ring-primary" data-id="' + c.id + '" ' + checked + '/></td>' +
        '<td class="px-4 py-4"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full ' + color + ' flex items-center justify-center font-bold text-xs">' + initials + '</div><span class="text-sm font-medium">' + (c.name || '—') + '</span></div></td>' +
        '<td class="px-4 py-4"><span class="text-sm text-slate-600 dark:text-slate-400 font-mono">' + (c.phone_number || '—') + '</span></td>' +
        '<td class="px-4 py-4"><span class="text-xs text-slate-400">—</span></td>' +
        '<td class="px-4 py-4"><span class="text-xs text-slate-400">—</span></td>' +
        '<td class="px-4 py-4"><span class="text-sm text-slate-500">' + (c.updated_at ? new Date(c.updated_at).toLocaleDateString() : '—') + '</span></td>' +
        '<td class="px-8 py-4 text-right"><button class="delete-btn text-slate-400 hover:text-red-500 transition-colors" data-id="' + c.id + '" title="Delete"><span class="material-icons">delete</span></button></td>' +
        '</tr>';
    }).join('');
    attachRowListeners();
  }

  // Pagination
  function renderPagination() {
    var totalPages = Math.max(1, Math.ceil(totalContacts / LIMIT));
    var start = (currentPage - 1) * LIMIT + 1;
    var end = Math.min(currentPage * LIMIT, totalContacts);
    if (totalContacts === 0) { start = 0; end = 0; }
    pageRange.textContent = start + ' - ' + end;
    pageTotal.textContent = totalContacts.toLocaleString();
    pageInfo.textContent = currentPage + ' / ' + totalPages;
    prevBtn.disabled = currentPage <= 1;
    nextBtn.disabled = currentPage >= totalPages;
    prevBtn.classList.toggle('text-slate-400', currentPage <= 1);
    nextBtn.classList.toggle('text-slate-400', currentPage >= totalPages);
  }

  prevBtn.addEventListener('click', function () { if (currentPage > 1) { currentPage--; loadContacts(); } });
  nextBtn.addEventListener('click', function () { var tp = Math.ceil(totalContacts / LIMIT); if (currentPage < tp) { currentPage++; loadContacts(); } });

  // Search
  searchInput.addEventListener('input', function () {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(function () { searchTerm = searchInput.value.trim(); currentPage = 1; loadContacts(); }, 400);
  });

  // Select all
  selectAll.addEventListener('change', function () {
    var checks = tbody.querySelectorAll('.row-check');
    checks.forEach(function (cb) { cb.checked = selectAll.checked; toggleSelection(parseInt(cb.dataset.id), selectAll.checked); });
    updateBulkBar();
  });

  function toggleSelection(id, state) {
    if (state) selectedIds.add(id); else selectedIds.delete(id);
  }

  function attachRowListeners() {
    tbody.querySelectorAll('.row-check').forEach(function (cb) {
      cb.addEventListener('change', function () { toggleSelection(parseInt(cb.dataset.id), cb.checked); updateBulkBar(); });
    });
    tbody.querySelectorAll('.delete-btn').forEach(function (btn) {
      btn.addEventListener('click', function () { deleteSingle(parseInt(btn.dataset.id)); });
    });
  }

  function updateBulkBar() {
    if (selectedIds.size > 0) {
      bulkBar.classList.remove('hidden');
      bulkCount.textContent = selectedIds.size + ' Selected';
      bulkSelectAll.checked = selectedIds.size === contacts.length;
    } else {
      bulkBar.classList.add('hidden');
    }
  }

  // Bulk delete
  bulkDeleteBtn.addEventListener('click', async function () {
    if (!selectedIds.size) return;
    if (!confirm('Delete ' + selectedIds.size + ' contact(s)?')) return;
    try {
      await WamatorAPI.delete('/contacts/' + appUser.id + '/batch-remove', Array.from(selectedIds));
      selectedIds.clear();
      updateBulkBar();
      selectAll.checked = false;
      loadContacts();
    } catch (err) { alert('Failed to delete contacts'); }
  });

  bulkSelectAll.addEventListener('change', function () {
    selectAll.checked = bulkSelectAll.checked;
    selectAll.dispatchEvent(new Event('change'));
  });

  // Single delete
  async function deleteSingle(id) {
    if (!confirm('Delete this contact?')) return;
    try {
      await WamatorAPI.delete('/contacts/' + appUser.id + '/batch-remove', [id]);
      selectedIds.delete(id);
      updateBulkBar();
      loadContacts();
    } catch (err) { alert('Failed to delete contact'); }
  }

  // Import button
  if (importBtn) importBtn.addEventListener('click', function () { window.location.href = '/setup/step-3.html'; });

  // Init
  loadContacts();
})();
</script>
</body></html>